---
- name: Despliegue de ARK_DEPLOY en ProducciÃ³n
  hosts: ark_servers
  become: false
  vars:
    project_path: "/home/raztreuzz/ark_deploy"

  pre_tasks:
    - name: Validar que env_file fue provisto
      ansible.builtin.assert:
        that:
          - env_file is defined
          - env_file | length > 0
        fail_msg: "Falta -e env_file=... (ruta al .env.prod en Jenkins/agent)"

    - name: Validar que repo_dir fue provisto
      ansible.builtin.assert:
        that:
          - repo_dir is defined
          - repo_dir | length > 0
        fail_msg: "Falta -e repo_dir=... (ruta al workspace del repo en Jenkins/agent)"

    - name: Validar que compose_file fue provisto
      ansible.builtin.assert:
        that:
          - compose_file is defined
          - compose_file | length > 0
        fail_msg: "Falta -e compose_file=... (ruta al docker-compose.prod.yml en Jenkins/agent)"

  tasks:
    - name: 1. Creando directorio del proyecto si no existe
      ansible.builtin.file:
        path: "{{ project_path }}"
        state: directory
        mode: "0755"

    - name: 2. Copiando archivo .env.prod desde Jenkins al servidor
      ansible.posix.synchronize:
        src: "{{ env_file }}"
        dest: "{{ project_path }}/.env.prod"
        delete: false

    - name: 3. Sincronizando archivos del proyecto
      ansible.posix.synchronize:
        src: "{{ repo_dir }}/"
        dest: "{{ project_path }}/"
        delete: true
        rsync_opts:
          - "--exclude=.git"
          - "--exclude=.idea"
          - "--exclude=.vscode"
          - "--exclude=node_modules"
          - "--exclude=frontend/node_modules"
          - "--exclude=.env"
          - "--exclude=.env.prod"

    - name: 4. Copiando docker-compose.prod.yml desde Jenkins al servidor
      ansible.posix.synchronize:
        src: "{{ compose_file }}"
        dest: "{{ project_path }}/docker-compose.prod.yml"
        delete: false

    - name: 5. Levantar la infraestructura con Docker Compose
      community.docker.docker_compose_v2:
        project_src: "{{ project_path }}"
        files:
          - docker-compose.prod.yml
        state: present
        build: always
        pull: missing

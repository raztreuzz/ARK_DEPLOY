import React, { useState, useEffect, useRef } from 'react';
import {
  Play,
  RefreshCw,
  Trash2,
  Activity,
  CheckCircle2,
  Clock,
  AlertCircle,
  Server,
  Terminal,
  Search,
  Settings,
  ShieldCheck,
  Globe,
  Link2,
  Cpu,
  Copy,
  Eraser,
  ExternalLink,
  Package,
  Tag,
  Layers,
  X,
  Plus,
  ArrowRight,
  ShieldAlert
} from 'lucide-react';

const INITIAL_PRODUCTS = [
  {
    id: 'prod-1',
    name: 'ARK Survival Evolved',
    version: 'v2.4.1',
    env: 'PROD',
    status: 'success',
    lastRun: 'Hace 2 horas',
    buildNum: '#42',
    description: 'Instancia principal del servidor de juego con persistencia activa.'
  },
  {
    id: 'prod-2',
    name: 'ARK Cluster Maps',
    version: 'v1.0.5',
    env: 'STAGING',
    status: 'idle',
    lastRun: 'Ayer',
    buildNum: '#12',
    description: 'Sincronización de mapas y transferencias de personajes entre servidores.'
  },
  {
    id: 'prod-3',
    name: 'ARK Database Service',
    version: 'v3.0.0',
    env: 'PROD',
    status: 'failed',
    lastRun: 'Hace 5 min',
    buildNum: '#89',
    description: 'Servicio de almacenamiento de perfiles y estados de tribus.'
  },
];

const INITIAL_NODES = [
  { name: 'ark-prod-01', ip: '100.82.15.42', status: 'active', region: 'Local' },
  { name: 'ark-backup-02', ip: '100.10.5.20', status: 'idle', region: 'Cloud' },
  { name: 'dev-node-razie', ip: '100.12.0.5', status: 'offline', region: 'Local' }
];

export default function App() {
  const [products, setProducts] = useState(INITIAL_PRODUCTS);
  const [tailscaleNodes, setTailscaleNodes] = useState(INITIAL_NODES);
  const [filter, setFilter] = useState('');
  const [activeExecution, setActiveExecution] = useState(null);
  const [followLogs, setFollowLogs] = useState(true);

  // Modales
  const [isDeployModalOpen, setIsDeployModalOpen] = useState(false);
  const [isNewDeviceModalOpen, setIsNewDeviceModalOpen] = useState(false);
  const [selectedProductForDeploy, setSelectedProductForDeploy] = useState(null);
  const [tempTargetHost, setTempTargetHost] = useState('');

  const [logs, setLogs] = useState([
    { id: 1, time: '14:30:05', msg: '[System] ARK_DEPLOY backend ready.', type: 'sys' },
    { id: 2, time: '14:31:10', msg: '[Tailscale] Connected to private mesh.', type: 'sys' }
  ]);

  const logEndRef = useRef(null);

  useEffect(() => {
    if (followLogs && logEndRef.current) {
      logEndRef.current.scrollIntoView({ behavior: 'smooth' });
    }
  }, [logs, followLogs]);

  const openDeployModal = (product) => {
    setSelectedProductForDeploy(product);
    setTempTargetHost(tailscaleNodes[0]?.ip || '');
    setIsDeployModalOpen(true);
  };

  const confirmDeployment = () => {
    const host = tailscaleNodes.find(n => n.ip === tempTargetHost);

    if (!host || host.status === 'offline') {
      addLog(`Error crítico: El destino seleccionado no es válido o está fuera de línea.`, 'err');
      return;
    }

    setIsDeployModalOpen(false);
    setActiveExecution({
      productName: selectedProductForDeploy.name,
      action: 'Deploy',
      target: host.name,
      status: 'provisioning',
      buildId: `#${Math.floor(Math.random() * 100) + 100}`
    });

    addLog(`Desplegando ${selectedProductForDeploy.name} en ${host.name} (${host.ip})...`, 'info');

    setTimeout(() => {
      setActiveExecution(prev => prev ? ({ ...prev, status: 'running' }) : null);
      addLog(`[Jenkins] Workspace inicializado en nodo remoto.`, 'info');
      addLog(`[Pipeline] Stage: Pulling Docker Images`, 'stage');
    }, 1500);
  };

  const addNewDevice = (e) => {
    e.preventDefault();
    const formData = new FormData(e.target);
    const newNode = {
      name: formData.get('name'),
      ip: `100.${Math.floor(Math.random()*255)}.${Math.floor(Math.random()*255)}.${Math.floor(Math.random()*255)}`,
      status: 'active',
      region: formData.get('region')
    };
    setTailscaleNodes([...tailscaleNodes, newNode]);
    addLog(`[Tailscale] Nuevo dispositivo registrado: ${newNode.name}`, 'sys');
    setIsNewDeviceModalOpen(false);
  };

  const addLog = (msg, type = 'info') => {
    setLogs(prev => [...prev, {
      id: Date.now() + Math.random(),
      time: new Date().toLocaleTimeString(),
      msg,
      type
    }]);
  };

  const getLogColor = (type) => {
    switch(type) {
      case 'err': return 'text-red-400';
      case 'stage': return 'text-cyan-400 font-bold underline';
      case 'sys': return 'text-slate-500 italic';
      default: return 'text-slate-300';
    }
  };

  return (
    <div className="min-h-screen bg-slate-950 text-slate-100 font-sans p-4 md:p-8 flex flex-col">
      {/* Header */}
      <header className="max-w-7xl w-full mx-auto mb-8 flex flex-col md:flex-row md:items-center justify-between gap-4">
        <div className="flex items-center gap-4">
          <div className="p-3 bg-blue-600/10 rounded-2xl border border-blue-500/20 shadow-[0_0_20px_rgba(59,130,246,0.1)]">
            <Package className="text-blue-400 w-8 h-8" />
          </div>
          <div>
            <h1 className="text-2xl font-black tracking-tight uppercase">ARK <span className="text-blue-500">Products</span></h1>
            <div className="flex items-center gap-2 text-[10px] text-slate-500 font-bold uppercase tracking-wider">
              <span className="flex items-center gap-1 text-green-500"><ShieldCheck size={12}/> VPN: {tailscaleNodes.length} Nodes</span>
              <span className="text-slate-800">/</span>
              <span>Jenkins: Connected</span>
            </div>
          </div>
        </div>

        <button
          onClick={() => setIsNewDeviceModalOpen(true)}
          className="flex items-center gap-2 px-4 py-2 bg-slate-900 border border-slate-800 rounded-xl text-xs font-bold hover:bg-slate-800 transition-all text-slate-300"
        >
          <Plus size={16} className="text-blue-400" /> Add Tailscale Device
        </button>
      </header>

      <main className="max-w-7xl w-full mx-auto grid grid-cols-1 lg:grid-cols-12 gap-8 flex-1">

        {/* Columna Principal: Catálogo de Productos */}
        <div className="lg:col-span-8 space-y-6">

          {activeExecution && (
            <div className="bg-blue-600/10 border-2 border-blue-500/20 rounded-2xl p-6 ring-1 ring-blue-500/30">
              <div className="flex items-center justify-between">
                <div className="flex items-center gap-4">
                  <div className="w-12 h-12 bg-blue-600 rounded-xl flex items-center justify-center shadow-lg shadow-blue-900">
                    <RefreshCw className="text-white animate-spin" size={24} />
                  </div>
                  <div>
                    <h2 className="text-lg font-bold">Deploying to {activeExecution.target}</h2>
                    <p className="text-sm text-blue-300/70 font-medium">{activeExecution.productName} • Build {activeExecution.buildId}</p>
                  </div>
                </div>
                <div className="text-right">
                  <span className="text-[10px] bg-blue-500 text-white px-3 py-1 rounded-full font-black uppercase tracking-widest">
                    Status: {activeExecution.status}
                  </span>
                </div>
              </div>
            </div>
          )}

          <div className="space-y-4">
            <div className="flex items-center justify-between px-2">
              <h3 className="text-xs font-black text-slate-500 uppercase tracking-[0.2em] flex items-center gap-2">
                <Layers size={14} /> Available Products
              </h3>
              <div className="relative">
                <Search size={14} className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-600" />
                <input
                  type="text"
                  placeholder="Filter products..."
                  className="bg-slate-900/50 border border-slate-800 rounded-lg pl-9 pr-4 py-1.5 text-xs focus:ring-1 ring-blue-500 outline-none w-48 transition-all focus:w-64"
                  onChange={(e) => setFilter(e.target.value)}
                />
              </div>
            </div>

            <div className="grid gap-4">
              {products.filter(p => p.name.toLowerCase().includes(filter.toLowerCase())).map((product) => (
                <div
                  key={product.id}
                  className="bg-slate-900/30 border border-slate-800/60 rounded-2xl p-6 hover:bg-slate-900/50 transition-all group relative overflow-hidden"
                >
                  <div className="flex flex-col lg:flex-row justify-between gap-6 relative z-10">
                    <div className="flex-1">
                      <div className="flex items-center gap-3 mb-2">
                        <h4 className="text-lg font-bold text-slate-100">{product.name}</h4>
                        <span className={`text-[10px] px-2 py-0.5 rounded font-black ${product.env === 'PROD' ? 'bg-red-500/10 text-red-400' : 'bg-yellow-500/10 text-yellow-500'}`}>
                          {product.env}
                        </span>
                        <span className="flex items-center gap-1 text-[10px] text-slate-500 font-mono italic">
                          <Tag size={10} /> {product.version}
                        </span>
                      </div>
                      <p className="text-sm text-slate-500 max-w-xl leading-relaxed">
                        {product.description}
                      </p>

                      <div className="flex items-center gap-4 mt-4 text-[11px] font-bold text-slate-600 uppercase tracking-tighter">
                        <span className="flex items-center gap-1.5"><CheckCircle2 size={14} className={product.status === 'success' ? 'text-green-500' : 'text-slate-700'}/> Last: {product.buildNum}</span>
                        <span className="flex items-center gap-1.5"><Clock size={14}/> {product.lastRun}</span>
                      </div>
                    </div>

                    <div className="flex flex-col justify-center gap-2 shrink-0">
                      <button
                        onClick={() => openDeployModal(product)}
                        className="flex items-center justify-center gap-2 px-6 py-2.5 bg-blue-600 hover:bg-blue-500 text-white rounded-xl text-xs font-black uppercase transition-all shadow-xl shadow-blue-950/40 active:scale-95"
                      >
                        <Play size={14} fill="currentColor" /> New Deployment
                      </button>
                    </div>
                  </div>
                </div>
              ))}
            </div>
          </div>
        </div>

        {/* Columna Derecha: Infraestructura y Logs */}
        <div className="lg:col-span-4 space-y-6">
          <section className="bg-slate-900/80 border border-slate-800 rounded-2xl p-5 shadow-2xl">
            <h3 className="text-[10px] font-black text-slate-600 uppercase tracking-[0.2em] mb-4">Tailscale Mesh Nodes</h3>
            <div className="space-y-4">
              {tailscaleNodes.map((node) => (
                <div key={node.ip} className="flex items-center justify-between group cursor-default">
                  <div className="flex items-center gap-3">
                    <div className={`w-2 h-2 rounded-full ${node.status === 'active' ? 'bg-green-500 shadow-[0_0_10px_rgba(34,197,94,0.6)]' : node.status === 'idle' ? 'bg-yellow-500' : 'bg-slate-800'}`} />
                    <div>
                      <p className="text-xs font-black text-slate-300 group-hover:text-white transition-colors uppercase">{node.name}</p>
                      <p className="text-[9px] text-slate-600 font-mono tracking-tighter">{node.ip}</p>
                    </div>
                  </div>
                  <div className="text-right">
                    <span className="text-[9px] text-slate-700 font-black uppercase tracking-widest">{node.region}</span>
                  </div>
                </div>
              ))}
            </div>
          </section>

          <section className="bg-black border border-slate-800 rounded-2xl overflow-hidden flex flex-col h-[500px] shadow-2xl">
            <div className="bg-slate-900/80 px-4 py-3 border-b border-slate-800 flex items-center justify-between">
              <div className="flex items-center gap-2">
                <Terminal size={14} className="text-blue-500" />
                <span className="text-[10px] font-black text-slate-500 uppercase tracking-widest">Live Output</span>
              </div>
              <button
                onClick={() => setLogs([])}
                className="p-1 hover:bg-slate-800 rounded text-slate-600 hover:text-slate-400 transition-colors"
              >
                <Eraser size={14} />
              </button>
            </div>

            <div className="p-5 font-mono text-[10px] overflow-y-auto flex-1 space-y-2 bg-[#050505] custom-scrollbar selection:bg-blue-500/30">
              {logs.map((log) => (
                <div key={log.id} className="flex gap-4 leading-relaxed group border-l border-transparent hover:border-slate-800 pl-2 -ml-2">
                  <span className="text-slate-800 shrink-0 select-none">[{log.time}]</span>
                  <span className={`${getLogColor(log.type)} tracking-tight`}>{log.msg}</span>
                </div>
              ))}
              <div ref={logEndRef} />
            </div>
          </section>
        </div>
      </main>

      {/* MODAL: Configurar Despliegue */}
      {isDeployModalOpen && (
        <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/80 backdrop-blur-sm">
          <div className="bg-slate-900 border border-slate-800 w-full max-w-md rounded-2xl shadow-2xl overflow-hidden">
            <div className="px-6 py-4 border-b border-slate-800 flex items-center justify-between bg-slate-800/30">
              <h2 className="font-black uppercase tracking-widest text-sm flex items-center gap-2">
                <Play size={16} className="text-blue-500" /> Deployment Setup
              </h2>
              <button onClick={() => setIsDeployModalOpen(false)} className="text-slate-500 hover:text-white transition-colors">
                <X size={20} />
              </button>
            </div>
            <div className="p-6 space-y-6">
              <div>
                <label className="text-[10px] font-black text-slate-500 uppercase mb-2 block tracking-widest">Selected Product</label>
                <div className="bg-slate-950 p-4 rounded-xl border border-slate-800 flex items-center gap-4">
                   <div className="p-2 bg-blue-500/10 rounded-lg"><Package className="text-blue-400" size={20}/></div>
                   <div>
                     <p className="font-bold text-slate-100">{selectedProductForDeploy?.name}</p>
                     <p className="text-xs text-slate-500">{selectedProductForDeploy?.version}</p>
                   </div>
                </div>
              </div>

              <div>
                <label className="text-[10px] font-black text-slate-500 uppercase mb-2 block tracking-widest">Select Target Node</label>
                <div className="space-y-2">
                  {tailscaleNodes.map(node => (
                    <button
                      key={node.ip}
                      disabled={node.status === 'offline'}
                      onClick={() => setTempTargetHost(node.ip)}
                      className={`w-full p-4 rounded-xl border flex items-center justify-between transition-all ${
                        tempTargetHost === node.ip
                        ? 'bg-blue-600/10 border-blue-500/50 ring-1 ring-blue-500/20'
                        : 'bg-slate-950 border-slate-800 hover:border-slate-700 opacity-60 hover:opacity-100'
                      } ${node.status === 'offline' ? 'opacity-30 cursor-not-allowed' : ''}`}
                    >
                      <div className="flex items-center gap-3">
                        <div className={`w-2 h-2 rounded-full ${node.status === 'active' ? 'bg-green-500' : 'bg-slate-700'}`} />
                        <div className="text-left">
                          <p className="text-xs font-bold uppercase">{node.name}</p>
                          <p className="text-[10px] text-slate-500 font-mono">{node.ip}</p>
                        </div>
                      </div>
                      {tempTargetHost === node.ip && <CheckCircle2 size={16} className="text-blue-400" />}
                    </button>
                  ))}
                </div>
              </div>
            </div>
            <div className="p-6 bg-slate-950 border-t border-slate-800 flex gap-3">
              <button
                onClick={() => setIsDeployModalOpen(false)}
                className="flex-1 px-4 py-3 bg-slate-900 hover:bg-slate-800 rounded-xl text-xs font-bold uppercase transition-all"
              >
                Cancel
              </button>
              <button
                onClick={confirmDeployment}
                className="flex-[2] px-4 py-3 bg-blue-600 hover:bg-blue-500 text-white rounded-xl text-xs font-black uppercase transition-all shadow-lg shadow-blue-900/40 flex items-center justify-center gap-2"
              >
                Launch Pipeline <ArrowRight size={16} />
              </button>
            </div>
          </div>
        </div>
      )}

      {/* MODAL: Agregar Dispositivo Tailscale */}
      {isNewDeviceModalOpen && (
        <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/80 backdrop-blur-sm">
          <div className="bg-slate-900 border border-slate-800 w-full max-w-sm rounded-2xl shadow-2xl overflow-hidden">
            <div className="px-6 py-4 border-b border-slate-800 flex items-center justify-between">
              <h2 className="font-black uppercase tracking-widest text-sm flex items-center gap-2 text-slate-400">
                <Link2 size={16} className="text-blue-500" /> New Mesh Node
              </h2>
              <button onClick={() => setIsNewDeviceModalOpen(false)} className="text-slate-500 hover:text-white">
                <X size={20} />
              </button>
            </div>
            <form onSubmit={addNewDevice} className="p-6 space-y-4">
              <div className="bg-blue-500/5 p-4 rounded-xl border border-blue-500/10 mb-4 flex gap-3">
                <ShieldAlert className="text-blue-400 shrink-0" size={18} />
                <p className="text-[11px] text-slate-400 leading-relaxed font-medium">
                  Asegúrate de que el dispositivo tenga Tailscale instalado.
                </p>
              </div>
              <div>
                <label className="text-[10px] font-black text-slate-500 uppercase mb-2 block">Device Name</label>
                <input
                  required
                  name="name"
                  type="text"
                  placeholder="ej. web-server-node"
                  className="w-full bg-slate-950 border border-slate-800 rounded-xl px-4 py-3 text-sm focus:ring-1 ring-blue-500 outline-none text-white"
                />
              </div>
              <div>
                <label className="text-[10px] font-black text-slate-500 uppercase mb-2 block">Region / Tags</label>
                <select
                  name="region"
                  className="w-full bg-slate-950 border border-slate-800 rounded-xl px-4 py-3 text-sm outline-none cursor-pointer text-white"
                >
                  <option value="Local">Local Data Center</option>
                  <option value="Cloud">Public Cloud (AWS/GCP)</option>
                  <option value="Edge">Edge Computing</option>
                </select>
              </div>
              <button
                type="submit"
                className="w-full mt-4 py-3 bg-blue-600 hover:bg-blue-500 text-white rounded-xl text-xs font-black uppercase transition-all shadow-lg shadow-blue-900/40"
              >
                Generate Auth Key
              </button>
            </form>
          </div>
        </div>
      )}

      <style>{`
        .custom-scrollbar::-webkit-scrollbar {
          width: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
          background: transparent;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
          background: #1e293b;
          border-radius: 10px;
        }
      `}</style>
    </div>
  );
}